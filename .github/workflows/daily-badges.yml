name: Daily Badge Updates

on:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-coverage-badge:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libcurl4-openssl-dev \
          libjansson-dev \
          libsecp256k1-dev \
          uuid-dev \
          lcov \
          gcovr

    - name: Build with coverage
      run: |
        make clean
        make CFLAGS="-O0 -g --coverage -fprofile-arcs -ftest-coverage" LDFLAGS="--coverage -lgcov"

    - name: Run tests for coverage
      run: |
        ./build/bin/test_ccxt_describe || true
        ./build/bin/test_crypto_msgpack || true

    - name: Generate coverage report
      run: |
        lcov --capture --directory . --output-file coverage.info --include "*/src/*" --exclude "*/tests/*" --exclude "*/examples/*" || true
        lcov --remove coverage.info '/usr/*' '*/tests/*' '*/examples/*' --output-file coverage.info || true

    - name: Calculate coverage
      run: |
        COVERAGE=$(lcov --summary coverage.info 2>&1 | grep "lines......" | sed 's/.*: \([0-9.]*\)%.*/\1/' || echo "0.0")
        echo "Current coverage: $COVERAGE%"
        ./scripts/generate-coverage-badge.sh "$COVERAGE"

    - name: Update README with coverage badge
      run: |
        COVERAGE_PERCENT="${{ env.COVERAGE_PERCENTAGE }}"
        COVERAGE_COLOR="${{ env.COVERAGE_COLOR }}"

        if [ -n "$COVERAGE_PERCENT" ]; then
          sed -i "s|https://img.shields.io/badge/coverage-[0-9.]*%25-[a-z]*.svg|https://img.shields.io/badge/coverage-${COVERAGE_PERCENT}%25-${COVERAGE_COLOR}.svg|g" README.md
        fi

    - name: Update README with modularity badge
      run: |
        ./scripts/check-modularity.sh || true

        MODULARITY_GRADE="${{ env.MODULARITY_GRADE }}"
        MODULARITY_COLOR="${{ env.MODULARITY_COLOR }}"

        if [ -n "$MODULARITY_GRADE" ]; then
          sed -i "s|https://img.shields.io/badge/modularity-[A-Z+]*-[a-z]*.svg|https://img.shields.io/badge/modularity-${MODULARITY_GRADE}-${MODULARITY_COLOR}.svg|g" README.md
        fi

    - name: Commit badge updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Daily badge update - Coverage: ${{ env.COVERAGE_PERCENTAGE }}%, Modularity: ${{ env.MODULARITY_GRADE }}" || true
          git push || true
        fi
